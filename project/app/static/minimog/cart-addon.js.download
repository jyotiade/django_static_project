class MCartAddons extends HTMLElement{constructor(){super(),this.selectors={zipCode:'[name="address[zip]"]',province:'[name="address[province]"]',country:'[name="address[country]"]',addressForm:'[data-address="root"]',shippingMessage:".m-cart-addon__shipping-rate",cartDiscountCode:'[name="discount"]',cartDiscountCodeNoti:"[data-discount-noti]",cartNote:'[name="note"]',saveAddonButton:".m-cart-addon--save",closeAddonButton:".m-cart-addon--close",calcShippingButton:".m-cart-addon--calculate",triggerAddonButton:".m-cart-addon--trigger-button",devliveryTime:'[name="attributes[Delivery time]"]'},this.cartWrapper=document.querySelector(".m-cart-drawer"),this.isCartPage=MinimogSettings.templateName==="cart",this.isCartPage&&(this.cartWrapper=document.querySelector(".m-cart__footer--wrapper")),this.initAddress=!1,this.cartOverlay=this.cartWrapper.querySelector(".m-cart__overlay"),this.domNodes=queryDomNodes(this.selectors,this),this.rootUrl=window.Shopify.routes.root,this.discountCodeKey="minimog-discount-code",this.deliveryCodeKey="minimog-delivery-code",this.init()}init(){const{cartDiscountCode,cartDiscountCodeNoti,devliveryTime}=this.domNodes;if(addEventDelegate({selector:this.selectors.triggerAddonButton,context:this,handler:(e,addonButton)=>{if(e.preventDefault(),this.isCartPage){const addonCurrentActive=document.querySelector(".m-cart-addon__body.open");addonCurrentActive&&addonCurrentActive.classList.remove("open")}const{open:addonTarget}=addonButton.dataset,addonNode=this.cartWrapper.querySelector(`#m-addons-${addonTarget}`);this.removeActiveAllButton(),addonButton.classList.add("active"),addonNode&&addonNode.classList.add("open"),this.cartOverlay&&this.cartOverlay.classList.add("open"),this.openAddon=addonNode,addonTarget==="shipping"&&fetchSection("country-options",{url:window.MinimogSettings.base_url}).then(html=>{const select=html.querySelector("#AddressCountry"),options=select&&select.querySelectorAll("option"),defaultSelect=addonNode.querySelector("#MadrressCountry select");options&&options.forEach(option=>{defaultSelect&&defaultSelect.appendChild(option)}),this.setupCountries(),defaultSelect.value=defaultSelect&&defaultSelect.dataset.default}).catch(console.error)}}),addEventDelegate({selector:this.selectors.closeAddonButton,context:this.cartWrapper,handler:this.close.bind(this)}),addEventDelegate({selector:this.selectors.calcShippingButton,context:this.cartWrapper,handler:this.calcShipping.bind(this)}),cartDiscountCode){const code=localStorage.getItem(this.discountCodeKey);code&&(cartDiscountCode.value=code,cartDiscountCodeNoti&&(cartDiscountCodeNoti.style.display="inline"))}if(devliveryTime){const code=localStorage.getItem(this.deliveryCodeKey);code&&(devliveryTime.value=code)}this.saveAddonValue();const today=new Date().toISOString().slice(0,16),deliveryTimeElm=this.querySelector("#delivery-time");deliveryTimeElm&&(deliveryTimeElm.min=today)}removeActiveAllButton(){const triggerButtons=this.querySelectorAll(this.selectors.triggerAddonButton);triggerButtons&&triggerButtons.forEach(button=>button.classList.remove("active"))}setupCountries(){this.initAddress||Shopify&&Shopify.CountryProvinceSelector&&(new Shopify.CountryProvinceSelector("AddressCountry","AddressProvince",{hideElement:"AddressProvinceContainer"}),this.initAddress=!0)}close(event){event.preventDefault(),this.openAddon.classList.remove("open"),this.cartOverlay&&this.cartOverlay.classList.remove("open"),this.removeActiveAllButton(),this.openAddon=null}calcShipping(event){event.preventDefault();const actionsWrapper=event.target.closest(".m-cart-addon__action");actionsWrapper.classList.add("m-spinner-loading");const zipCode=this.domNodes.zipCode&&this.domNodes.zipCode.value&&this.domNodes.zipCode.value.trim(),country=this.domNodes.country.value,province=this.domNodes.province.value;this.domNodes.shippingMessage.classList.remove("error"),this.domNodes.shippingMessage.innerHTML="";const showDeliveryDays=actionsWrapper.dataset.showDeliveryDays==="true";fetch(`${this.rootUrl}cart/shipping_rates.json?shipping_address%5Bzip%5D=${zipCode}&shipping_address%5Bcountry%5D=${country}&shipping_address%5Bprovince%5D=${province}`).then(res=>res.json()).then(res=>{if(res&&res.shipping_rates){const{shipping_rates}=res,{shippingRatesResult,noShippingRate}=MinimogStrings;if(shipping_rates.length>0){actionsWrapper.classList.remove("m-spinner-loading");const shippingLabel=document.createElement("P");shippingLabel.classList.add("m-cart-addon__shipping-rate--label"),shippingLabel.innerHTML=`${shippingRatesResult.replace("{{count}}",shipping_rates.length)}:`,this.domNodes.shippingMessage.appendChild(shippingLabel),shipping_rates.map(rate=>{const{deliveryOne="Day",deliveryOther="Days"}=actionsWrapper.dataset;let deliveryDays="";if(rate.delivery_days.length>0&&showDeliveryDays){let textDay=deliveryOne;const firstDeliveryDay=rate.delivery_days[0],lastDeliveryDay=rate.delivery_days.at(-1);firstDeliveryDay>1&&(textDay=deliveryOther),firstDeliveryDay===lastDeliveryDay?deliveryDays=`(${firstDeliveryDay} ${textDay})`:deliveryDays=`(${firstDeliveryDay} - ${lastDeliveryDay} ${textDay})`}const shippingRateItem=document.createElement("P");shippingRateItem.classList.add("m-cart-addon__shipping-rate--item"),shippingRateItem.innerHTML=`${rate.name}: <span>${rate.price} ${Shopify.currency.active}</span> ${deliveryDays}`,this.domNodes.shippingMessage.appendChild(shippingRateItem)})}else actionsWrapper.classList.remove("m-spinner-loading"),this.domNodes.shippingMessage.innerHTML=`<p>${noShippingRate}</p>`}else actionsWrapper.classList.remove("m-spinner-loading"),Object.entries(res).map(error=>{this.domNodes.shippingMessage.classList.add(error[0]&&error[0].toLowerCase());const message=`${error[1][0]}`,shippingRateError=document.createElement("P");shippingRateError.classList.add("m-cart-addon__shipping-rate--error"),shippingRateError.innerHTML=`${message}<sup>*</sup>`,this.domNodes.shippingMessage.appendChild(shippingRateError)})}).catch(console.error)}saveAddonValue(){addEventDelegate({event:"click",context:this.cartWrapper,selector:this.selectors.saveAddonButton,handler:(event,target)=>{event.preventDefault();const{cartDiscountCode,cartDiscountCodeNoti,devliveryTime}=this.domNodes;if(target.dataset.action==="coupon"&&cartDiscountCode){const code=cartDiscountCode.value;localStorage.setItem(this.discountCodeKey,code),code!==""&&cartDiscountCodeNoti?cartDiscountCodeNoti.style.display="inline":cartDiscountCodeNoti.style.display="none",this.close(event)}if(target.dataset.action==="note"&&(this.updateCartNote(),this.close(event)),target.dataset.action==="delivery"){const code=devliveryTime.value;Date.parse(code)>Date.now()?(localStorage.setItem(this.deliveryCodeKey,code),this.close(event)):(localStorage.setItem(this.deliveryCodeKey,""),devliveryTime.value="",window.MinimogTheme.Notification.show({target:this.querySelector(".m-cart-addon-message-error"),method:"appendChild",type:"error",message:window.MinimogStrings.valideDateTimeDelivery,last:3e3,sticky:!1}))}}})}updateCartNote(){const cartNoteValue=this.domNodes.cartNote.value,body=JSON.stringify({note:cartNoteValue});fetch(`${window.MinimogSettings.routes.cart_update_url}`,{...fetchConfig(),body})}}customElements.define("m-cart-addons",MCartAddons);
//# sourceMappingURL=/cdn/shop/t/17/assets/cart-addon.js.map?v=172077844944557670081720081180
